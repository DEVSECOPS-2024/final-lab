name: CI

on:
  
  push:
  workflow_dispatch:
  
jobs:
  
  build:
    
    runs-on: ubuntu-latest

    steps:
      - name: Descarga repositorio
        uses: actions/checkout@v3
               
      #- name: Compilacion JAVA
      #  run: |
      #    chmod +x gradlew
      #    ./gradlew build
          
      #- name: Copia de Jar a Raiz de proyecto
      #  run: |
      #    cp $GITHUB_WORKSPACE/build/libs/final-lab-2.6.0-plain.jar .
      #    chmod 777 final-lab-2.6.0-plain.jar
      #    ls -ltra    
          
      - name: Dependency Check
        uses: dependency-check/Dependency-Check_Action@1.1.0
        with:
          project: 'lab-final'
          path: '.'
          format: 'HTML' 
      
      - name: Upload Test results
        uses: actions/upload-artifact@master
        with:
           name: Depcheck report
           path: ${{github.workspace}}/reports

      - name: Docker Login   
        uses: docker/login-action@v2.2.0
        with:
          username: ${{secrets.DOCKER_USERNAME}}
          password: ${{secrets.DOCKER_PASSWORD}}
          
      - name: Docker Build
        run: |
          docker build --tag mfigueroah/final-lab .
          docker images

      - name: Docker Push
        run: |
          docker push mfigueroah/final-lab:latest
 
  test:
  
    needs: build
    runs-on: ubuntu-latest
    steps: 
                
    - name: Descarga repositorio
      uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '14'

    - name: Install dependencies
      run: npm install

    - name: Run tests and coverage
      run: npm test -- --coverage
    
    - name: SonarCloud
      uses: actions/checkout@v3
      with:
        fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis

    
    - name: SonarCloud Scan
      uses: SonarSource/sonarcloud-github-action@master
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
    
    
    #- name: Set up JDK 17
    #  uses: actions/setup-java@v4.0.0
    #  with:
    #      java-version: 17
    #      distribution: 'temurin'
     
    #- name: Build      
    #  run: |
    #      chmod +x gradlew
    #      ./gradlew build
    #      ls -ltrh build/libs  
          
    #- name: SAST (Static Application Security Testing)     
    #  run: |
    #    chmod +x gradlew
    #   ./gradlew build sonar -Dsonar.token=${{secrets.SONAR_TOKEN}}

   
  #deploy:
    
    #runs-on: self-hosted
    #needs: test
    #steps:
      
      #- uses: actions/checkout@v3

      #- name: Deploy to Minukube
        #run: |
          #kubectl apply -f deployment.yml
